on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  packages: write
  id-token: write

name: Release
jobs:
  release:
    if: github.repository == 'ethlimo/ens-hooks'
    runs-on: ubuntu-latest
    environment: Production
    steps:

        # step-security/harden-runner@v2.13.2
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            fulcio.sigstore.dev:443
            get.anchore.io:443
            github.com:443
            grype.anchore.io:443
            malware-list.aikido.dev:443
            npm.pkg.github.com:443
            raw.githubusercontent.com:443
            registry.npmjs.org:443
            rekor.sigstore.dev:443
            release-assets.githubusercontent.com:443
            uploads.github.com:443   
                   
      - name: Checkout the repo
        # actions/checkout@v5
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Release Please
        # googleapis/release-please-action@v4.3.0
        uses: googleapis/release-please-action@c2a5a2bd6a758a0937f1ddb1e8950609867ed15c
        if: github.event_name != 'workflow_dispatch'
        id: release
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Dependency Scan (Grype)
        if: steps.release.outputs.release_created == 'true' || github.event_name == 'workflow_dispatch'
        id: grype-scan
        uses: ./.github/actions/sca 

      - name: Build SBOM
        if: steps.release.outputs.release_created == 'true' || github.event_name == 'workflow_dispatch'
        id: build-sbom
        uses: ./.github/actions/sbom 

      - name: Set up Node.js environment
        if: steps.release.outputs.release_created == 'true' || github.event_name == 'workflow_dispatch'
        uses: ./.github/actions/nodejs_setup
        id: setup-node

      - name: Install dependencies
        if: steps.release.outputs.release_created == 'true' || github.event_name == 'workflow_dispatch'
        id: install-dependencies
        uses: ./.github/actions/ci 

      - name: Publish NPM Package (GitHub)
        if: steps.release.outputs.release_created == 'true' || github.event_name == 'workflow_dispatch'
        uses: ./.github/actions/publish
        with:
          node-auth-token: ${{ secrets.GITHUB_TOKEN }}
          registry-url: "https://npm.pkg.github.com"

      - name: Publish NPM Package (npmjs)
        if: steps.release.outputs.release_created == 'true' || github.event_name == 'workflow_dispatch'
        uses: ./.github/actions/publish
        with:
          node-auth-token: ${{ secrets.NPM_TOKEN }}
          registry-url: "https://registry.npmjs.org"
          
      - name: Upload SBOM to Release Assets
        if: steps.release.outputs.release_created == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ steps.release.outputs.tag_name }} ./sbom.spdx.json

